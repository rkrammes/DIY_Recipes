<!DOCTYPE html>
<html lang="en" data-theme="terminal-mono">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIY Recipes | Formula Database</title>
    <link rel="stylesheet" href="styles/tokens.css">
    <link rel="stylesheet" href="styles/animations.css">
    <link rel="stylesheet" href="styles/retro-terminal.css">
    <style>
        /* Critical first-load styles */
        @font-face {
          font-family: 'IBM Plex Mono';
          src: url('/fonts/IBMPlexMono-Regular.woff2') format('woff2');
          font-weight: 400;
          font-style: normal;
          font-display: swap;
        }
        
        @font-face {
          font-family: 'VGA';
          src: url('/fonts/Px437_IBM_VGA_8x16.woff') format('woff');
          font-weight: 400;
          font-style: normal;
          font-display: swap;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'IBM Plex Mono', monospace;
            background-color: oklch(var(--surface-0));
            color: oklch(var(--text-primary));
            line-height: 1.5;
        }
        
        * {
            box-sizing: border-box;
        }
        
        /* Terminal layout grid */
        .terminal-layout {
            display: grid;
            grid-template-areas:
                "command command command"
                "nav workspace actions";
            grid-template-rows: 60px 1fr;
            grid-template-columns: minmax(200px, 1fr) minmax(500px, 3fr) minmax(200px, 1fr);
            min-height: 100vh;
            max-height: 100vh;
            overflow: hidden;
        }
        
        .command-terminal {
            grid-area: command;
            border-bottom: 1px solid oklch(var(--border-subtle));
            display: flex;
            align-items: center;
            padding: 0 1rem;
            gap: 1rem;
            background-color: oklch(var(--surface-1));
        }
        
        .navigation-matrix {
            grid-area: nav;
            border-right: 1px solid oklch(var(--border-subtle));
            overflow-y: auto;
            padding: 1rem 0;
        }
        
        .primary-workspace {
            grid-area: workspace;
            overflow-y: auto;
            padding: 1.5rem;
            position: relative;
        }
        
        .action-panel {
            grid-area: actions;
            border-left: 1px solid oklch(var(--border-subtle));
            overflow-y: auto;
            padding: 1rem;
            background-color: oklch(var(--surface-1), 0.5);
        }
        
        /* Navigation styles */
        .terminal-nav-section {
            margin-bottom: 1.5rem;
        }
        
        .terminal-nav-header {
            padding: 0.25rem 1rem;
            font-size: 0.75rem;
            opacity: 0.7;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        /* Terminal loading overlay */
        .terminal-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: oklch(var(--surface-0));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .terminal-loading-logo {
            font-family: 'VGA', monospace;
            font-size: 2rem;
            margin-bottom: 2rem;
            color: oklch(var(--text-accent));
        }
        
        .terminal-loading-status {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 1rem;
            margin-top: 2rem;
            color: oklch(var(--text-secondary));
        }
        
        /* Modal container */
        .terminal-modal-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .terminal-modal-container.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .terminal-modal {
            background-color: oklch(var(--surface-1));
            border: 1px solid oklch(var(--border-accent));
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .terminal-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid oklch(var(--border-subtle));
        }
        
        .terminal-modal-content {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
        }
        
        .terminal-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1rem;
            border-top: 1px solid oklch(var(--border-subtle));
        }
        
        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .terminal-layout {
                grid-template-areas:
                    "command command"
                    "nav workspace"
                    "actions actions";
                grid-template-rows: 60px 1fr auto;
                grid-template-columns: minmax(200px, 1fr) minmax(500px, 3fr);
            }
            
            .action-panel {
                border-left: none;
                border-top: 1px solid oklch(var(--border-subtle));
                max-height: 200px;
            }
        }
        
        @media (max-width: 768px) {
            .terminal-layout {
                grid-template-areas:
                    "command"
                    "workspace"
                    "nav"
                    "actions";
                grid-template-rows: 60px 1fr auto auto;
                grid-template-columns: 1fr;
            }
            
            .navigation-matrix {
                border-right: none;
                border-top: 1px solid oklch(var(--border-subtle));
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="terminal-loading-overlay" id="loadingOverlay">
        <div class="terminal-loading-logo terminal-flicker">DIY.SYS FORMULA DATABASE</div>
        <div class="terminal-progress" style="width: 300px;">
            <div class="terminal-progress-bar" style="width: 0%;" id="loadingProgressBar"></div>
        </div>
        <div class="terminal-loading-status" id="loadingStatus">INITIALIZING SYSTEM</div>
    </div>

    <div class="terminal-layout">
        <!-- Command Terminal (Top Bar) -->
        <header class="command-terminal">
            <div class="terminal-status-container">
                <span class="terminal-status-light terminal-status-active"></span>
                <span class="terminal-vga">DIY.SYS</span>
            </div>
            
            <div class="terminal-input-container" style="flex: 1; margin: 0 2rem;">
                <input type="text" class="terminal-input" placeholder="ENTER COMMAND" id="commandInput">
            </div>
            
            <div class="terminal-status-container" style="margin-left: auto;">
                <span class="terminal-vga terminal-flicker" id="systemStatus">READY</span>
            </div>
            
            <div class="terminal-time">
                <span class="terminal-monospace" id="terminalTime">--:--:--</span>
            </div>
        </header>
        
        <!-- Navigation Matrix (Left Column) -->
        <nav class="navigation-matrix" id="navigationMatrix">
            <!-- This will be populated by formula-database-ui.js with the renderFormulasMatrix function -->
            <div id="formulaList" class="terminal-matrix">
                <!-- Loading placeholder -->
                <div class="terminal-loading">LOADING FORMULA DATABASE...</div>
            </div>
        </nav>
        
        <!-- Primary Workspace (Center Column) -->
        <main class="primary-workspace terminal-grid-bg" id="formulaWorkspace">
            <!-- This will be populated by formula-database-ui.js with the showFormulaDetails function -->
            <div class="terminal-panel">
                <div class="terminal-panel-title">FORMULA DATABASE</div>
                <div class="terminal-panel-content">
                    <div class="terminal-text-reveal">
                        Select a formula from the Navigation Matrix to view details.
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Action Panel (Right Column) -->
        <aside class="action-panel" id="actionPanel">
            <!-- This will be populated by ActionRenderer with context-aware actions -->
            <div class="terminal-panel">
                <div class="terminal-panel-title">SYSTEM OPERATIONS</div>
                <div class="terminal-button" style="width: 100%; margin-bottom: 0.5rem;">
                    CREATE NEW FORMULA
                </div>
                <div class="terminal-button" style="width: 100%; margin-bottom: 0.5rem;">
                    SEARCH DATABASE
                </div>
                <div class="terminal-button" style="width: 100%; margin-bottom: 0.5rem;">
                    TOGGLE TERMINAL MODE
                </div>
            </div>
            
            <div class="terminal-panel" style="margin-top: 1rem;">
                <div class="terminal-panel-title">SYSTEM STATUS</div>
                <div class="terminal-status-container" style="margin-bottom: 0.5rem;">
                    <span class="terminal-status-light terminal-status-active"></span>
                    <span>FORMULA DATABASE</span>
                </div>
                <div class="terminal-status-container" style="margin-bottom: 0.5rem;">
                    <span class="terminal-status-light terminal-status-active"></span>
                    <span>TERMINAL INTERFACE</span>
                </div>
                <div class="terminal-status-container" style="margin-bottom: 0.5rem;">
                    <span class="terminal-status-light terminal-status-standby"></span>
                    <span>MCP CONNECTION</span>
                </div>
            </div>
        </aside>
    </div>
    
    <!-- Modal Container for Dialogs -->
    <div class="terminal-modal-container" id="terminalModalContainer"></div>
    
    <!-- JS Module Imports - Order matters! -->
    <!-- Original Recipe System (for data access) -->
    <script type="module" src="js/supabaseClient.js"></script>
    <script type="module" src="js/api.js"></script>
    <script type="module" src="js/app-store.js"></script>
    <script type="module" src="js/ui-utils.js"></script>
    
    <!-- Core Terminal Modules -->
    <script type="module" src="js/dev-memory.js"></script>
    <script type="module" src="js/terminal-components.js"></script>
    
    <!-- Action System -->
    <script type="module" src="js/action-registry.js"></script>
    <script type="module" src="js/terminal-action-registry.js"></script>
    <script type="module" src="js/terminal-action-renderer.js"></script>
    
    <!-- Formula Database UI -->
    <script type="module" src="js/formula-database-ui.js"></script>
    
    <!-- Action Definitions -->
    <script type="module" src="js/formula-actions.js"></script>
    <script type="module" src="js/element-actions.js"></script>
    <script type="module" src="js/system-actions.js"></script>
    
    <!-- Control Matrix (Settings) -->
    <script type="module" src="js/control-matrix.js"></script>
    
    <!-- Main Terminal Initialization -->
    <script type="module" src="js/terminal-main.js"></script>
    
    <script>
        // Page loading sequence for better UX
        document.addEventListener('DOMContentLoaded', () => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingProgressBar = document.getElementById('loadingProgressBar');
            const loadingStatus = document.getElementById('loadingStatus');
            const systemStatus = document.getElementById('systemStatus');
            const terminalTime = document.getElementById('terminalTime');
            
            let progress = 0;
            const loadingInterval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(loadingInterval);
                    
                    // Show completed status
                    loadingStatus.textContent = 'SYSTEM INITIALIZED';
                    
                    // Remove loading overlay with delay for effect
                    setTimeout(() => {
                        loadingOverlay.style.opacity = '0';
                        setTimeout(() => {
                            loadingOverlay.style.display = 'none';
                        }, 300);
                    }, 500);
                } else {
                    // Update loading messages for effect
                    if (progress < 30) {
                        loadingStatus.textContent = 'INITIALIZING CORE SYSTEMS';
                    } else if (progress < 50) {
                        loadingStatus.textContent = 'LOADING FORMULA DATABASE';
                    } else if (progress < 70) {
                        loadingStatus.textContent = 'ESTABLISHING CONNECTIONS';
                    } else if (progress < 90) {
                        loadingStatus.textContent = 'CALIBRATING INTERFACE';
                    } else {
                        loadingStatus.textContent = 'FINALIZING STARTUP';
                    }
                }
                
                loadingProgressBar.style.width = `${progress}%`;
            }, 200);
            
            // Terminal time updater
            function updateTime() {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                
                terminalTime.textContent = `${hours}:${minutes}:${seconds}`;
                setTimeout(updateTime, 1000);
            }
            updateTime();
            
            // Command input handling
            const commandInput = document.getElementById('commandInput');
            if (commandInput) {
                commandInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        const command = this.value.trim().toUpperCase();
                        
                        // Update status
                        systemStatus.textContent = 'PROCESSING';
                        
                        // Reset input
                        this.value = '';
                        
                        // Process commands (simple examples)
                        setTimeout(() => {
                            if (command === 'HELP') {
                                alert('[TERMINAL HELP]\nAvailable commands:\nHELP - Show this help\nSTATUS - Show system status\nCLEAR - Clear workspace\nREFRESH - Refresh data');
                            } else if (command === 'STATUS') {
                                alert('[SYSTEM STATUS]\nAll systems operational\nFormula Database: Online\nElement Library: Online\nMCP Connection: Limited');
                            } else if (command === 'CLEAR') {
                                const workspace = document.getElementById('formulaWorkspace');
                                if (workspace) {
                                    workspace.innerHTML = '<div class="terminal-panel"><div class="terminal-panel-title">WORKSPACE CLEARED</div><div class="terminal-panel-content"><div class="terminal-text-reveal">Workspace reset to default state.</div></div></div>';
                                }
                            } else if (command === 'REFRESH') {
                                location.reload();
                            } else {
                                alert(`[ERROR]\nUnrecognized command: ${command}\nType HELP for available commands.`);
                            }
                            
                            // Reset status
                            systemStatus.textContent = 'READY';
                        }, 500);
                    }
                });
            }
            
            // Initialize terminal audio system if available
            if (window.AudioContext || window.webkitAudioContext) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const context = new AudioContext();
                
                // Simple terminal beep
                window.terminalAudio = {
                    playButtonSound: function() {
                        const osc = context.createOscillator();
                        const gain = context.createGain();
                        
                        osc.connect(gain);
                        gain.connect(context.destination);
                        
                        osc.type = 'square';
                        osc.frequency.value = 880;
                        gain.gain.value = 0.05;
                        
                        osc.start();
                        
                        setTimeout(() => {
                            osc.stop();
                        }, 50);
                    },
                    
                    playToggleSound: function() {
                        const osc = context.createOscillator();
                        const gain = context.createGain();
                        
                        osc.connect(gain);
                        gain.connect(context.destination);
                        
                        osc.type = 'square';
                        osc.frequency.value = 440;
                        gain.gain.value = 0.05;
                        
                        osc.start();
                        
                        setTimeout(() => {
                            osc.stop();
                        }, 100);
                    },
                    
                    playAdjustSound: function() {
                        const osc = context.createOscillator();
                        const gain = context.createGain();
                        
                        osc.connect(gain);
                        gain.connect(context.destination);
                        
                        osc.type = 'sine';
                        osc.frequency.value = 660;
                        gain.gain.value = 0.02;
                        
                        osc.start();
                        
                        setTimeout(() => {
                            osc.stop();
                        }, 30);
                    }
                };
            }
        });
        
        // Initialize Formula Database UI when window is fully loaded
        window.addEventListener('load', () => {
            // Check if module system initialized properly
            if (typeof window.initFormulaDatabaseUI === 'function') {
                window.initFormulaDatabaseUI();
                window.loadAndRenderFormulas();
            } else {
                console.error('Formula Database UI modules not loaded correctly');
            }
        });
    </script>
</body>
</html>